/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let initStyles=require("./styles/index.js").initStyles,createTreeTableState=require("./state/treeTableState").createTreeTableState,createTableHeader=require("./components/tableHeader").createTableHeader,createTableBody=require("./components/tableBody").createTableBody,createPagination=require("./components/pagination/pagination").createPagination,{setupDynamicUpdates,expandAllNodesWithChildren}=require("./components/tableUtils"),{handleNodeExpansion,handleExpandToChild,handleExpandToLatest}=require("./components/tableHandlers"),{groupNodesByLatestTimestamp,findNodeById,arrayToTree}=require("./utils/treeUtils"),extendStateWithSelectionOptions=require("./components/selectionManagement/selectionState").extendStateWithSelectionOptions,createSelectionManagement=require("./components/selectionManagement/").createSelectionManagement,{chevronRightSvg,chevronDownSvg}=require("./constants");function TreeTable(d,e,t={}){let{decorator:l={},rowsPerPage:a=10,showHeader:i=!0,showPagination:r=!0,styles:n=null,columns:o=[],autoExpandRoot:s=!1,currentNodeId:c=null,toggleButtonInColumn:g=!1,indentBase:h=30,onAddContext:u=null,onSelectionChange:p=null,onSelectionStateChange:S=null,visualDayBreaks:b=!0,sortRootBy:m="updated_at",sortRootOrder:y="desc",chatApi:C=null,batchChatsSize:N=25,showSelectionCheckboxes:f=!1}=t;initStyles(n,h);var v,t=[{key:"current_node_indicator",label:"",visible:!1,width:"20px"},{key:"name",label:"Name",visible:!0,width:"40%",render:(e,t,a)=>{t=t.name?.(e)||e.name,e=document.createElement("span");return e.className="node-name",a&&"object"==typeof t&&(e.appendChild(a),t.style.verticalAlign="middle"),"string"==typeof t?e.textContent=t:e.appendChild(t),e}},{key:"chats",label:"Chats",visible:!0,width:"20%"},{key:"created_at",label:"Created At",visible:!0,width:"20%",render:(e,t)=>t.createdAt?.(e)||e.created_at},{key:"latest_child",label:"Latest Child",visible:!0,width:"20%"},{key:"toggle_button",label:"",visible:g,width:"20px"},{key:"actions",label:"Actions",visible:!0,width:"20%"},{key:"selection",label:"",visible:!1,width:"20px"}];null!==c&&(v=findNodeById(d,c))&&(v.current_node=!0);let P=t.map(t=>{var e=o.find(e=>e.key===t.key);return e?{...t,...e}:t}),x=P.filter(e=>e.visible);x.map(e=>e.width);if(!(e instanceof Element))throw new Error("Container must be a DOM element");let T=createTreeTableState(d,a),w=(T=extendStateWithSelectionOptions(T),document.createElement("div")),I=(w.className="tree-table-container",e.innerHTML="",document.createElement("div")),E=(I.className="scrollable-table-container",P.find(e=>"selection"===e.key)?.visible||!1),B=E?createSelectionManagement({state:T,chatApi:C,batchChatsSize:N,showCheckboxes:f,onAddContext:(e,t)=>{u&&"function"==typeof u&&u(e,t)},onConfigChange:()=>{q(),B.updateSelectionUI(),S&&S(T.getSelectedNodes(),T.selectionOptions)}}):{element:document.createElement("div"),updateSelectionUI:()=>{}};function k(){E&&B.updateSelectionUI&&B.updateSelectionUI();T.getSelectedNodes();D()}function D(){w.querySelectorAll('input[type="checkbox"]').forEach(e=>{e.checked=T.isNodeSelected(parseInt(e.closest("tr").dataset.id))})}e.appendChild(B.element),e.appendChild(I);let R={state:T,toggleButtonInColumn:g,chatApi:C,toggleChildren:(e,t)=>{handleNodeExpansion({nodeId:e,button:t,container:w,state:T,decorator:l,columns:x,handlers:R})},toggleNodeSelection:async(e,t)=>{var a=T.findNodeById(e);a&&("git-ref"!==a.type||a.kids&&0!==a.kids.length||T.hasFetchedDescendants(e)||!R.chatApi?.getGitRefChatDescendants||(T.addFetchedDescendants(e),a=await R.chatApi.getGitRefChatDescendants(e),T.addChildrenToNode(e,a)),T.toggleNodeSelection(e,t),D(),k(),p&&(a=T.getSelectedNodes().length,e=T.getSelectedNodes(),p(a,e)),S)&&S(T.getSelectedNodes(),T.selectionOptions)},expandToChild:(e,t)=>handleExpandToChild({rootNodeId:e,childNodeId:t,data:T.getData(),container:w,state:T,decorator:l,columns:x,handlers:R}),expandToLatestChild:e=>{handleExpandToLatest({rootNodeId:e,data:T.getData(),container:w,state:T,decorator:l,columns:x,handlers:R})},expandAllNodesWithChildren:()=>{expandAllNodesWithChildren({container:w,state:T,decorator:l,columns:x,handlers:R})},changePage:e=>{T.setCurrentPage(e),q()},changePageSize:e=>{T.setCurrentPage(1),T.setRowsPerPage(e),q()}};function q(){w.innerHTML="";var e=document.createElement("table"),t=(e.className="tree-table",d.filter(e=>0===e.parent_id)),a=(T.getCurrentPage()-1)*T.getRowsPerPage(),n=a+T.getRowsPerPage(),a=t.slice(a,n);let o=groupNodesByLatestTimestamp(a);var n=Object.keys(o).find(e=>0<o[e].length)||"",n=(i&&e.appendChild(createTableHeader({columns:x,dayBreakGroup:n})),createTableBody({data:T.getData(),currentPage:T.getCurrentPage(),rowsPerPage:T.getRowsPerPage(),decorator:l,handlers:R,columns:x,visualDayBreaks:b,sortRootBy:m,sortRootOrder:y})),n=(e.appendChild(n),t.length),t=Math.ceil(n/T.getRowsPerPage()),t=createPagination({currentPage:T.getCurrentPage(),totalPages:t,totalItems:n,itemsPerPage:T.getRowsPerPage(),onPageChange:R.changePage,onPageSizeChange:R.changePageSize});w.appendChild(e),I.innerHTML="",I.appendChild(w),r&&I.appendChild(t),T.getData().forEach(e=>{var t;T.isNodeExpanded(e.id)&&(t=w.querySelector(`tr[data-id="${e.id}"]`))&&(t=t.querySelector(".expand-button"))&&("collapsed"===t.dataset.state||"false"===t.dataset.expanded)&&R.toggleChildren(e.id,t)}),s&&0<a.length&&(n=a[0],e=w.querySelector(`tr[data-id="${n.id}"]`))&&(t=e.querySelector(".expand-button"))&&("collapsed"===t.dataset.state||"false"===t.dataset.expanded)&&R.toggleChildren(n.id,t),k(),D()}return q(),setupDynamicUpdates({container:w,state:T,decorator:l}),{refresh:()=>{q()},destroy:()=>{T.clearUpdateInterval(),e.innerHTML=""},goToPage:e=>{R.changePage(e)},getCurrentPage:()=>T.getCurrentPage(),getRowsPerPage:()=>T.getRowsPerPage(),showColumn:t=>{var e=P.find(e=>e.key===t);e&&(e.visible=!0,q())},hideColumn:t=>{var e=P.find(e=>e.key===t);e&&(e.visible=!1,q())},expandNode:e=>{var t=w.querySelector(`tr[data-id="${e}"]`);t&&(t=t.querySelector(".expand-button"))&&("collapsed"===t.dataset.state||"false"===t.dataset.expanded)&&R.toggleChildren(e,t)},collapseNode:e=>{var t=w.querySelector(`tr[data-id="${e}"]`);t&&(t=t.querySelector(".expand-button"))&&("expanded"===t.dataset.state||"true"===t.dataset.expanded)&&R.toggleChildren(e,t)},expandToChild:(e,t)=>handleExpandToChild({rootNodeId:e,childNodeId:t,data:T.getData(),container:w,state:T,decorator:l,columns:x,handlers:R}),expandToLatestChild:e=>{handleExpandToLatest({rootNodeId:e,data:T.getData(),container:w,state:T,decorator:l,columns:x,handlers:R})},expandAllNodesWithChildren:()=>{expandAllNodesWithChildren({container:w,state:T,decorator:l,columns:x,handlers:R})},updateData:e=>{T=createTreeTableState(e,T.getRowsPerPage()),T=extendStateWithSelectionOptions(T),q()},addChildrenToNode:(e,t,a)=>{T.addChildrenToNode(e,t,a)},findNode:(e,t)=>findNodeById(T.getNodeMap(),e,T.buildNodeMap,t),getNodePath:e=>findNodeById(T.getNodeMap(),e,T.buildNodeMap)?getPathToNode(T.getData()[0],e):null,showSelectionColumn:()=>{var e=P.find(e=>"selection"===e.key);e&&(e.visible=!0,q())},hideSelectionColumn:()=>{var e=P.find(e=>"selection"===e.key);e&&(e.visible=!1,q())},getStateId:()=>T.getId(),getSelectedNodes:()=>T.getSelectedNodes(),setRecursiveSelection:e=>{T.setRecursiveSelection(e),q()},setFileSelectionEnabled:e=>{T.setFileSelectionEnabled(e),q()},setDirectorySelectionEnabled:e=>{T.setDirectorySelectionEnabled(e),q()},resetSelectionOptions:()=>{T.setRecursiveSelection(!0),T.setFileSelectionEnabled(!0),T.setDirectorySelectionEnabled(!0),T.clearSelections(),q()},updateSelectionUI:()=>{k()},saveCurrentSelection:(e="Untitled",t=!1)=>{B&&B.saveCurrentSelection&&B.saveCurrentSelection(e,t)},async showContextBuilder(a,n,o,d,l={}){var{}=l,i=B.contextBuilderModal;if(i){let t=null;if(a){var r=[];t=[];for(let e=0;e<a.length;e++){var s,c,g=a[e],h=T.findNodeById(g);h||((c=[...(s=await C.getGitRefChatByFamilyMember(g)).descendants]).unshift(s),c=arrayToTree(c,"desc",s.id),T.addChildrenToNode(s.id,c),h=T.findNodeById(g))?t.push(h):badNodeIds.push(g)}if(r.length)throw new Error("No nodes with the ids found: "+JSON.stringify(r))}else t=T.getSelectedNodes();r=n||"overview",n=o||T.selectionOptions.selectedOption;let e=[];"file content"===r?e=t.filter(e=>"git-blob"===e.type):"overview"===r&&(e=t),0<e.length?i.show(e,r,n,d,l):console.warn(`No ${"file content"===r?"git-blob files":"nodes"} selected`)}else console.error("No contextBuilderModal instance defined in selectionManagementComponent")},getLoadedFiles(){return T.getLoadedFiles()},clearLoadedFiles(){T.clearLoadedFiles()},restoreSelectionFromIds(e,t){if(!e||0===e.length)return!1;T.clearSelections(),t&&(T.selectionOptions={...t});let a=0;return e.forEach(e=>{T.findNodeById(e)&&(T.toggleNodeSelection(e,!0),a++)}),q(),D(),0<a}}}module.exports=TreeTable;
