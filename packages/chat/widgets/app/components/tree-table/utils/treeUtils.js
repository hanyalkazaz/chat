/*
 * GitSense Chat - Minified Distribution File
 *
 * This JavaScript file is part of the minified distribution of GitSense Chat.
 * It has been optimized (minified) for performance and efficient delivery.
 *
 * This software is permitted for internal use and modification.
 * Copying for profit or redistribution is strictly not permitted.
 *
 * The Fair License, which formalizes these terms, will be adopted as the official license in the future.
 * Once finalized, the unminified source code will be freely available for internal use for non-
 * commercial purposes.
 *
 * This software may not be used to develop or enhance any product or service that competes
 * directly or indirectly with GitSense Chat without explicit permission.
 *
 * Copyright (c) 2025 GitSense. All rights reserved.
 */

let{formatAge,compareDates}=require("./dateUtils");function findLatestChild(e){let a=e.updated_at,i=e;let d=[e.id];return function t(e,r){e&&(e.updated_at&&0<compareDates(e.updated_at,a)&&(a=e.updated_at,i=e,d=[...r]),e.kids)&&0<e.kids.length&&e.kids.forEach(e=>{t(e,[...r,e.id])})}(e,[e.id]),{latestNode:i,path:d}}function getLatestChildTime(e){if(!e.kids||0===e.kids.length)return formatAge(e.updated_at);let a=null;return e.kids.forEach(e=>function t(e){var r;e.updated_at&&(r=new Date(e.updated_at+"Z").getTime(),!a||r>a)&&(a=r),e.kids&&0<e.kids.length&&e.kids.forEach(e=>t(e))}(e)),a?formatAge(new Date(a).toISOString()):"N/A"}function getLatestTimestampInSubtree(e){let t=e.updated_at;if(e.kids&&0<e.kids.length)for(var r of e.kids){r=getLatestTimestampInSubtree(r);r>t&&(t=r)}return t}function groupNodesByLatestTimestamp(e){var t,r={"Last 24 hours":[],"Previous 7 days":[],Older:[]},a=new Date;for(t of e){var i=getLatestTimestampInSubtree(t),i=new Date(i+(i.match(/Z/)?"":"Z")),i=Math.floor((a-i)/864e5);(0===i?r["Last 24 hours"]:i<=7?r["Previous 7 days"]:r.Older).push(t)}return r}function findNodeById(e,t,r){if(e&&"function"==typeof e.get)return e.get(t)||null;if(Array.isArray(e))for(var a of e){a=findNodeById(a,t);if(a)return a}else{if(e.id===t)return e;if(e.kids&&0<e.kids.length)for(var i of e.kids){i=findNodeById(i,t);if(i)return i}}return null}function getPathToNode(e,a){let i=null;return function t(e,r){e.id===a?i=r:e.kids&&e.kids.forEach(e=>{i||t(e,[...r,e.id])})}(e,[e.id]),i}function countDescendants(e){let r=0;return function t(e){e.kids&&(r+=e.kids.length,e.kids.forEach(e=>t(e)))}(e),r}function getMaxDepth(e){return function t(e){return e.kids&&0!==e.kids.length?1+Math.max(...e.kids.map(e=>t(e))):0}(e)}function isValidNode(t){return!!["id","parent_id","name","created_at","kids"].every(e=>e in t)&&"number"==typeof t.id&&"number"==typeof t.parent_id&&"string"==typeof t.name&&!!Array.isArray(t.kids)&&t.kids.every(e=>isValidNode(e))}function sortNodes(e,d){return e&&0!==e.length?e.slice().sort((e,t)=>{for(var r of d){var{field:r,order:a}=r,i=e[r],r=t[r];if("number"==typeof i&&"number"==typeof r){if(i!==r)return"asc"===a?i-r:r-i}else if(i instanceof Date&&r instanceof Date){if(i.getTime()!==r.getTime())return"asc"===a?i-r:r-i}else if("string"==typeof i&&"string"==typeof r){if(0!==i.localeCompare(r))return"asc"===a?i.localeCompare(r):r.localeCompare(i)}else{i=String(i),r=String(r);if(0!==i.localeCompare(r))return"asc"===a?i.localeCompare(r):r.localeCompare(i)}}return 0}):e}function sortNodesByOrderWeight(e,r="desc"){return e&&0!==e.length?e.slice().sort((e,t)=>{e=e.order_weight||0,t=t.order_weight||0;return"asc"===r?e-t:t-e}):e}function sortNodesByLatestChild(e,r="desc"){var t;return e&&0!==e.length?((t=e.slice().sort((e,t)=>{e=getLatestTimestampInSubtree(e),t=getLatestTimestampInSubtree(t);return"desc"===r?compareDates(t,e):compareDates(e,t)})).forEach(e=>{e.kids&&0<e.kids.length&&(e.kids=sortNodesByLatestChild(e.kids))}),t):e}function arrayToTree(e,r="desc",a=0){if(!["asc","desc"].includes(r))throw new Error("Sort order must be 'asc' or 'desc'");let i=new Map;function d(e){if(!e.maxDateTime){var t=e.kids.map(e=>d(e)),r=e.created_at?new Date(e.created_at):new Date;if(isNaN(r.getTime()))throw new Error(`Invalid created_at value for node ${e.id}: `+e.created_at);r=[r,...t];e.maxDateTime=new Date(Math.max(...r.map(e=>e.getTime())))}return e.maxDateTime}e.forEach(e=>{i.set(e.id,{...e,kids:[]})});let s=[];return e.forEach(e=>{var t=i.get(e.id);if(e.parent_id===a)s.push(t);else{var r=i.get(e.parent_id);if(r){if(e.parent_id!==r.id)throw new Error(`Child node ${e.id} has incorrect parent_id. Expected ${r.id}, found `+e.parent_id);r.kids.push(t)}}}),s.forEach(function e(t){t.kids.forEach(e),t.kids.sort((e,t)=>(e=d(e),t=d(t)-e,"asc"===r?-t:t))}),s.sort((e,t)=>{e=d(e),t=d(t)-e;return"asc"===r?-t:t}),s.forEach(function e(t){delete t.maxDateTime,t.kids.forEach(e)}),s}module.exports={arrayToTree:arrayToTree,findLatestChild:findLatestChild,getLatestChildTime:getLatestChildTime,getLatestTimestampInSubtree:getLatestTimestampInSubtree,groupNodesByLatestTimestamp:groupNodesByLatestTimestamp,findNodeById:findNodeById,getPathToNode:getPathToNode,countDescendants:countDescendants,getMaxDepth:getMaxDepth,isValidNode:isValidNode,sortNodes:sortNodes,sortNodesByOrderWeight:sortNodesByOrderWeight,sortNodesByLatestChild:sortNodesByLatestChild};
